services:
  home-index:
    image: ${IMAGE}
    environment:
      - METADATA_DIRECTORY=/home-index/metadata
      - MODULES=http://chunk-module:9000
      - RETRY_UNTIL_READY_SECONDS=180
      - DEBUG=${DEBUG:-False}
      - DEBUGPY_HOST=${DEBUGPY_HOST:-0.0.0.0}
      - DEBUGPY_PORT=${DEBUGPY_PORT:-5678}
      - WAIT_FOR_DEBUGPY_CLIENT=${WAIT_FOR_DEBUGPY_CLIENT:-False}
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
    ports:
      - "5678:5678"
    depends_on:
      - meilisearch
      - chunk-module
  meilisearch:
    image: getmeili/meilisearch:v1.15.2
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_LOG_LEVEL=warn
    volumes:
      - ./output/meili:/meili_data
    ports:
      - "7700:7700"
  chunk-module:
    build:
      context: ../chunk_module
      dockerfile: Dockerfile
    environment:
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
