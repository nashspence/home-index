# F4. "I want to detect duplicate files"

## Value

Grouping files by their content hash exposes duplicates without scanning by hand.

---

## Usage

When the container indexes your files, identical files share a single directory under `metadata/by-id/`. Each path appears in the document's `paths` map and the document's `copies` field counts how many paths resolve to the same file. The search engine stores these documents exactly once; fetch `/indexes/files/documents` to see `copies` reported alongside the `paths` map.

---

## Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      - CRON_EXPRESSION=* * * * * *
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
    depends_on:
      - meilisearch
  meilisearch:
    image: getmeili/meilisearch:latest
    volumes:
      - ./output/meili:/meili_data
    ports:
      - "7700:7700"
```

---

## User Testing

```bash
mkdir -p input output
echo "hello" > input/a.txt
cp input/a.txt input/b.txt
IMAGE=ghcr.io/nashspence/home-index:latest docker compose up -d
# fetch duplicates
curl -X POST \
  -H 'Content-Type: application/json' \
  -d '{"q":"", "filter": "copies = 2"}' \
  http://localhost:7700/indexes/files/search

# fetch unique files
curl -X POST \
  -H 'Content-Type: application/json' \
  -d '{"q":"", "filter": "copies = 1"}' \
  http://localhost:7700/indexes/files/search
```

After the first sync completes, inspect `output/metadata/by-id/` to find a single directory whose `document.json` lists both `a.txt` and `b.txt`.

---

## Input â†” Output

| **Your single action** | **What you will literally see** |
| --- | --- |
| Run `docker compose up -d` with two identical files in `./input/` | A single folder under `./output/metadata/by-id/` contains `document.json` with `paths` mapping both filenames. |
| POST to `/indexes/files/search` with `{"q":"", "filter": "copies = 2"}` | Results include one document whose `copies` field is `2` and lists both file paths. |
| POST to `/indexes/files/search` with `{"q":"", "filter": "copies = 1"}` | Results include one document whose `copies` field is `1`. |

---

## Acceptance

1. With two identical files in `./input/`, the first sync creates exactly one directory under `./output/metadata/by-id/`.
2. `document.json` in that directory lists both paths and records `"copies": 2`.
3. Filtering `/indexes/files/search` by `copies = 2` returns that document with `"copies": 2`.
