# F4. "I want to detect duplicate files"

## Value

Grouping files by their content hash exposes duplicates without scanning by hand.

---

## Usage

When the container indexes your files, identical files share a single directory under `metadata/by-id/`. Each path appears in the document's `paths` map and the `copies` field counts how many paths resolve to the same file.

Search the index for duplicates with `copies = 2` to retrieve that single document:

```bash
curl -X POST 'http://localhost:7700/indexes/files/search' \
  -H 'Content-Type: application/json' \
  --data '{"q": "", "filter": "copies = 2"}'
```

The result lists both file paths and shows `"copies": 2`.

---

## Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      - CRON_EXPRESSION=* * * * * *
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
    depends_on:
      - meilisearch
  meilisearch:
    image: getmeili/meilisearch:latest
    volumes:
      - ./output/meili:/meili_data
    ports:
      - "7700:7700"
```

---

## User Testing

```bash
mkdir -p input output
echo "hello" > input/a.txt
cp input/a.txt input/b.txt
IMAGE=ghcr.io/nashspence/home-index:latest docker compose up -d
```

After the first sync completes, inspect `output/metadata/by-id/` to find a single directory whose `document.json` lists both `a.txt` and `b.txt`.

You can also verify duplicates through Meilisearch. The search engine stores each set of copies only once. Query the index for duplicate files and the results expose the `copies` count:

```bash
curl -X POST 'http://localhost:7700/indexes/files/search' \
  -H 'Content-Type: application/json' \
  --data '{"q": "", "filter": "copies = 2"}'
```

The returned document lists both file paths with `"copies": 2`.

---

## Input â†” Output

| **Your single action** | **What you will literally see** |
| --- | --- |
| Run `docker compose up -d` with two identical files in `./input/` | A single folder under `./output/metadata/by-id/` contains `document.json` listing both filenames and `"copies": 2`. Running the search query above returns the same document. |

---

## Acceptance

1. With two identical files in `./input/`, the first sync creates exactly one directory under `./output/metadata/by-id/`.
2. `document.json` in that directory lists both paths and records `"copies": 2`.
3. Querying the search index with `copies = 2` returns that single document.
