# F4. "I want modules to enrich files"

## Value

Plug-in modules let you attach custom processors to each file. They can extract metadata or generate additional content like captions and OCR text. Modules may live on other machines as long as their RPC endpoints are reachable.

---

## Usage

Set the `MODULES` environment variable to a comma separated list of XML-RPC endpoints. These endpoints can be local containers or services running on other machines. Each module follows the [RPC spec](docs/rpc_module_spec.md) and runs in its own container. Home Index calls `hello`, `check`, `run`, and `unload` on every module in sequence whenever a file is indexed and at least one of its paths is available.

A basic module implementation is provided under `features/F4/module_template/`.

---

## Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      - MODULES=http://example-module:9000
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
    depends_on:
      - meilisearch
      - example-module
  meilisearch:
    image: getmeili/meilisearch:latest
    environment:
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ./output/meili:/meili_data
    ports:
      - "7700:7700"
  example-module:
    build:
      context: ./features/F4/module_template/
      dockerfile: Dockerfile
      args:
        HOME_INDEX_REF: ${HOME_INDEX_REF}
    environment:
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
```
Set ``HOME_INDEX_REF`` to the commit or tag of Home Index your module
expects. When not provided, ``main`` is used.

---

## User Testing

```bash
mkdir -p input output
printf 'text' > input/hello.txt
IMAGE=ghcr.io/nashspence/home-index:latest docker compose up -d
```

After the sync finishes a folder named after the module appears under `output/metadata/by-id/<file-hash>/`. The module's `version.json` file resides there and `modules.log` records its run.

---

## Input â†” Output

| **Your single action** | **What you will literally see** |
| --- | --- |
| Run `docker compose up -d` with `MODULES` configured | Each document gets a subdirectory under `output/metadata/by-id/` named after the module containing any artifacts it produced. `output/modules.log` shows the module start and completion. |

---

## Acceptance

1. Each configured module runs when at least one file path is online.
2. Module artifacts appear under `./output/metadata/by-id/<file-hash>/<module>/` after processing.
3. `hello_versions.json` records the module name and version so subsequent runs skip unchanged modules.

