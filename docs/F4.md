# F4 Modules enrich project files

## 1 Why use modules?
A **module** is a worker container that enriches project files with extra artefacts—EXIF, OCR, captions, thumbnails ….
Everything is orchestrated through **Redis queues**:

1. **Home‑Index** looks at the ordered **`MODULES` list** (§2.1) and enqueues a *check* job for the first module.
2. Each module container **peeks** at the next item in its queue:

   * If the item’s **`uid` matches its own `MODULE_UID`**, the module pulls and processes the job (`<name>:check` → `<name>:run`).
   * If the `uid` **differs**, the module writes a warning to its log, leaves the job on the queue and sleeps for **10 minutes** before looking again.
3. On completion the module places a summary on a *done* queue; Home‑Index consumes it, merges any `document` updates, updates **Meilisearch**, then schedules the next module.
4. Re‑build a module image (new **UID**) and, at the next start‑up, Home‑Index re‑queues every file from that module onwards.

Directory layout per file:

```
output/metadata/by-id/<file‑hash>/
├── document.json              # merged document for the file (all modules)
└── <module‑name>/             # one sub‑dir per module
    ├── content.json           # raw text / segment list (optional)
    ├── chunks.json            # auto‑chunked search docs (generated)
    ├── log.txt                # stdout / stderr from last run
    └── …                      # other artefacts the module writes
```

---

## 2 Configure the pipeline

### 2.1 Declare modules (order + UID)

```yaml
MODULES: |
  - name: vision-module
    uid: "bb07dfb4-3b2e-4f26-9a37-81ba0f227391"
  - name: text-module
    uid: "a0648b3c-114d-4eb4-a4c7-70e8b5c9d888"
```

* **Order matters** – files flow top → bottom.
* Each `uid` is printed by the build template; copy or script it into `MODULES`.
* At start‑up Home‑Index compares the list with the stored one; the first change point (name, uid or order) is the **re‑queue point** for all files.

### 2.2 Key environment variables in every module container

| Variable                                                        | Required | Meaning                                                                                                                    |
| --------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------- |
| `MODULE_NAME`                                                   | ✔        | Must equal the `name` in `MODULES`.                                                                                        |
| `MODULE_UID`                                                    | ✔        | Must equal the `uid` in `MODULES`. The container starts **but will ignore queue items whose uid differs** (see §1‑step 2). |
| `REDIS_HOST`                                                    | ✔        | Redis connection string.                                                                                                   |
| `TIMEOUT`, `WORKER_ID`, `RESOURCE_SHARES`, `METADATA_DIRECTORY` | ✖        | Optional controls – see below.                                                                                             |

---

## 3 Writing a module

Provide two required call‑backs—`check` and `run`—and (optionally) `load` / `unload`, then start the built‑in runtime:

```python
from features.F4.home_index_module import run_server

def check(file_path, document, metadata_dir):
    """Fast side‑effect‑free test: should run() execute?"""
    return not (metadata_dir / "chunks.json").is_file()

def run(file_path, document, metadata_dir):
    """Heavy work. Return data for Home‑Index to merge & index."""
    updated_doc = {"detected_labels": ["cat", "tree"]}
    raw_text    = "A cat is climbing a tree."
    return {"document": updated_doc, "content": raw_text}

if __name__ == "__main__":
    run_server(check, run)    # load/unload hooks optional
```

`run_server` automatically:

* polls queues,
* verifies **per‑item uid** (logs a warning & retries after 10 min on mismatch),
* handles timeouts & retries,
* captures per‑file `log.txt`,
* rotates share‑group tokens, and
* pushes results back to Home‑Index.

### 3.1 `run` return values

| Key          | Type                     | Effect                                                                                     |
| ------------ | ------------------------ | ------------------------------------------------------------------------------------------ |
| `"document"` | `dict`                   | Merged into **`document.json`** then re‑indexed in Meilisearch.                            |
| `"content"`  | `str` or `list[segment]` | Written to `content.json`; Home‑Index auto‑chunks to `chunks.json` and indexes the chunks. |
| others       | serialisable values      | Ignored by Home‑Index (you may still store artefacts manually).                            |

---

## 4 Acceptance criteria

| #      | Scenario                      | Steps → Expected result                                                                                                                                          |
| ------ | ----------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1**  | **Initial enrichment**        | Start stack with modules & files → each file gains `document.json`; artefacts searchable.                                                                        |
| **2**  | **New file**                  | Add file while running → metadata appears; file searchable.                                                                                                      |
| **3**  | **File replaced**             | Replace bytes (hash changes) → new directory created; old one remains.                                                                                           |
| **4**  | **Parallel modules**          | Two modules run; if one crashes the other finishes.                                                                                                              |
| **5**  | **Run‑timeout**               | Module exceeds `TIMEOUT` → job re‑queued; after fix completes.                                                                                                   |
| **6**  | **Check‑timeout**             | `check` hangs → job re‑queued; after fix completes.                                                                                                              |
| **7**  | **Restart, no change**        | Restart with unchanged `MODULES` → no jobs re‑queued.                                                                                                            |
| **8**  | **UID / order change**        | Change a `uid` or reorder list → restart → files re‑queued from first change; metadata regenerated.                                                              |
| **9**  | **Share‑group rotation**      | Two containers share `{name: gpu}` → turns alternate.                                                                                                            |
| **10** | **Multiple share groups**     | Module with `gpu` + `licence` groups → job runs only when holding both tokens; no starvation.                                                                    |
| **11** | **Meilisearch update**        | Module returns new `document`/`content` → Home‑Index merges JSON, rebuilds chunks, Meilisearch reflects updates.                                                 |
| **12** | **Queue item uid mismatch**   | Leave stale items with old uid in queue → module logs warning, skips them, retries after 10 min; once Home‑Index re‑queues with correct uid, processing resumes. |
| **13** | **Wrong MODULE\_UID env var** | Start container whose `MODULE_UID` is not in `MODULES` → container logs fatal mis‑configuration and exits.                                                       |
| **14** | **load/unload hooks**         | Hooks run exactly once per share‑group turn (observe logs).                                                                                                      |
| **15** | **Crash frees share token**   | Kill worker mid‑turn → next worker detects expired token and proceeds.                                                                                           |

All scenarios **must pass without editing this document**—only module names, UIDs and paths may vary.
 
**End of specification**
