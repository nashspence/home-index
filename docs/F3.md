# F3 Metadata for files on offline media

## 1 Why special support for offline media?

Removable media (USB disks, SD cards, external SSDs, network shares, …) are not always attached.
Home‑Index keeps their file metadata so you can still:

* search for a file even when its drive is unplugged,
* know **which** drive you must plug in to regain access,
* resume syncing the moment the drive re‑appears.

## 2 How it works

### 2.1 Configure an “archive root”

```yaml
environment:
  ARCHIVE_DIRECTORY: /files/archive   # default shown
```

*Every sub‑directory directly under this path represents one removable medium.*

### 2.2 Behaviour during every sync

1. **Classification**

   * If **all** paths of a document live in the archive root → the document is classed as *archived*.
2. **Symlink map**

   * Each archived file gets a symlink under
     `output/metadata/by-path/archive/<drive-name>/<relative-path>`
     pointing to `output/metadata/by-id/<file-hash>`.
3. **State flags on every document**

| Field               | Meaning                                                                         |
| ------------------- | ------------------------------------------------------------------------------- |
| `has_archive_paths` | `true` iff the document has ≥1 path beneath `ARCHIVE_DIRECTORY`.                |
| `offline`           | `true` iff **all** archive paths are currently unavailable (drive not mounted). |

Flags are stored in `document.json` and indexed in Meilisearch, so search results always reflect current drive state.

---

## 3 Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      ARCHIVE_DIRECTORY: /files/archive          # optional – keep if using default
      METADATA_DIRECTORY: /home-index/metadata
      REDIS_HOST: http://redis:6379              # if F4 modules are used
    volumes:
      - ./input:/files:ro                        # project files, incl. /input/archive
      - ./output:/home-index
    depends_on: [meilisearch]

  meilisearch:
    image: getmeili/meilisearch:latest
    environment: [MEILI_NO_ANALYTICS=true]
    volumes: [./output/meili:/meili_data]
```

---

## 4 Acceptance criteria (platform‑agnostic)

Any operating system (Linux, macOS, Windows + WSL) may be used.
Placeholders:

* `<drive‑X>` — a directory directly under `ARCHIVE_DIRECTORY` (e.g., `MyUSB`).
* `<file‑A>` — a regular file somewhere inside the drive root.

| #      | Scenario & pre‑conditions                                     | Steps (user actions → expected result)                                                                                                                                                                                                                    |
| ------ | ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1**  | **Drive online**<br>`<file‑A>` exists on mounted `<drive‑X>`. | 1 Start sync → Under `output/metadata` a symlink `by-path/archive/<drive‑X>/…/<file‑A>` points to `by-id/<file-hash>/`.<br>2 Document flags are `has_archive_paths =true`, `offline =false`.                                                              |
| **2**  | **Drive unplugged**                                           | 1 Unmount/remove `<drive‑X>`; leave filesystem tree empty.<br>2 Run sync → Symlink and `by-id` folder remain; flags change to `has_archive_paths =true`, `offline =true`.                                                                                 |
| **3**  | **Drive re‑attached *with* the file**                         | 1 Re‑mount `<drive‑X>` containing `<file‑A>`.<br>2 Sync → Flags revert to `has_archive_paths =true`, `offline =false`; no extra `by-id` folder is created.                                                                                                |
| **4**  | **Drive re‑attached *without* the file**                      | 1 Mount `<drive‑X>` but **delete** `<file‑A>` before sync.<br>2 Sync → Symlink and `by-id/<file-hash>` are **deleted**; document is removed from search results.                                                                                          |
| **5**  | **File copied to archive while drive is online**              | 1 Add `<file‑B>` to `<drive‑X>` while mounted.<br>2 Sync → New `by-id/<hash‑B>` and corresponding symlink appear; flags for that document are `has_archive_paths =true`, `offline =false`.                                                                |
| **6**  | **File exists on both archive and regular path**              | 1 Place identical bytes of `<file‑C>` in a non‑archive path and on `<drive‑X>`.<br>2 Sync → One `by-id` folder keyed by the shared hash; flags are `has_archive_paths =true`, `offline =false` (because at least one path is online).                     |
| **7**  | **Online copy deleted – archive offline**                     | 1 Delete non‑archive copy of `<file‑C>`; unmount `<drive‑X>` (now only archive path exists and is offline).<br>2 Sync → Flags become `has_archive_paths =true`, `offline =true`; document still searchable.                                               |
| **8**  | **Archive root renamed or moved**                             | 1 Unmount `<drive‑X>`; remount it under a *different* directory name `<drive‑Y>` inside `ARCHIVE_DIRECTORY`.<br>2 Sync → Old symlink tree under `<drive‑X>` is removed; new symlinks under `<drive‑Y>` created; flags update to `offline =false`.         |
| **9**  | **Multiple drives tracked independently**                     | 1 Mount `<drive‑X>` (online) and leave `<drive‑Z>` unplugged.<br>2 Sync → Files on `<drive‑X>` have `offline =false`; files only on `<drive‑Z>` have `offline =true`. Actions on one drive never alter flags for the other.                               |
| **10** | **Change of `ARCHIVE_DIRECTORY` path**                        | 1 After any successful run, stop stack.<br>2 Set `ARCHIVE_DIRECTORY` to a *new* location, move archive drives accordingly, restart.<br>3 Sync → All symlinks are regenerated under the new root; flags remain accurate (online drives → `offline=false`). |

All ten scenarios must succeed *without modifying this specification*—only the drive names, file names, and mount points vary per project.

---

**End of specification**
