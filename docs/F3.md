# F3. “I want metadata for files on offline media”

## Value

Keeping metadata for removable drives lets you search their contents even when the drive is unplugged. When you reattach the drive, syncing continues seamlessly.

---

## Usage

Set `ARCHIVE_DIRECTORY` to the mount-point you use for removable media (default: `/files/archive`).
During every sync Home-Index:

* keeps documents and symlinks for files whose only paths are in `ARCHIVE_DIRECTORY`,
* updates two Boolean flags on each document:

  | Field               | Meaning                                             |
  | ------------------- | --------------------------------------------------- |
  | `has_archive_paths` | at least one path lives under the archive directory |
  | `offline`           | **all** archive paths are currently unavailable     |

These fields are stored with every document and indexed in Meilisearch, so search results always show the current archive state.

---

## Acceptance

| Scenario                                  | Home-Index **input**                                                                        | Home-Index **output**                                                                                                                                                                                                                |
| ----------------------------------------- | ------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **1 – Archive drive online**              | Mount a drive under `ARCHIVE_DIRECTORY` that contains `<drive-name>/<file-on-drive>` and start the stack. | In `output/metadata/`: <br>• a folder `by-id/<file-hash>/` contains `document.json`.<br>• a symlink `by-path/archive/<drive-name>/<file-on-drive>` points to that folder.<br>The document’s flags are `has_archive_paths =true`, `offline =false`. |
| **2 – Drive unplugged**                   | Unmount or remove `<drive-name>`, leave the folder empty, then run sync again.                    | The same folder and symlink remain intact; the document’s flags update to `has_archive_paths =true`, `offline =true`.                                                                                                                |
| **3 – Drive reattached without the file** | Remount `<drive-name>` **without** `<file-on-drive>` present and run sync.                                | Both the folder `by-id/<file-hash>/` and the symlink `by-path/archive/<drive-name>/<file-on-drive>` disappear from `output/metadata/`.                                                                                                             |

---

## Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      - METADATA_DIRECTORY=/home-index/metadata
      # ARCHIVE_DIRECTORY defaults to /files/archive
    volumes:
      - ./input:/files:ro          # include ./input/archive for removable drives
      - ./output:/home-index
    depends_on:
      - meilisearch

  meilisearch:
    image: getmeili/meilisearch:latest
    environment:
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ./output/meili:/meili_data
```
