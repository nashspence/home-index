# F2. "I want to search for unique files by metadata"

## Value

Searching the index lets you quickly surface individual files even when duplicates exist.

---

## Usage

When the container indexes your files, each document is stored under `metadata/by-id/<file-id>/document.json` and every path gets a symlink in `metadata/by-path/`. Duplicate files share one document whose `paths` map lists all locations and the `copies` field counts them. This field is filterable so you can query unique files directly.

```bash
curl -X POST 'http://localhost:7700/indexes/files/search' \
  -H 'Content-Type: application/json' \
  --data '{"q": "", "filter": "copies = 1"}'
```

The result includes each unique file and shows its metadata.

---

## Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      - CRON_EXPRESSION=* * * * * *
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
    depends_on:
      - meilisearch
  meilisearch:
    image: getmeili/meilisearch:latest
    environment:
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ./output/meili:/meili_data
    ports:
      - "7700:7700"
```

---

## User Testing

```bash
mkdir -p input output
printf 'duplicate' > input/a.txt
cp input/a.txt input/b.txt
echo 'unique' > input/c.txt
IMAGE=ghcr.io/nashspence/home-index:latest docker compose up -d
```

After the first sync completes, inspect `output/metadata/by-id/` to see one folder for `a.txt` and `b.txt` and another for `c.txt`. Under `output/metadata/by-path/` each file path appears as a symlink.

Query Meilisearch to fetch the unique file by its metadata:

```bash
curl -X POST 'http://localhost:7700/indexes/files/search' \
  -H 'Content-Type: application/json' \
  --data '{"q": "", "filter": "paths = \"c.txt\""}'
```

The returned document lists only `c.txt` with `"copies": 1`.

---

## Input â†” Output

| **Your single action** | **What you will literally see** |
| --- | --- |
| Run `docker compose up -d` with the files above | Metadata appears under `./output/metadata/by-id/` and symlinks under `./output/metadata/by-path/`. Searching with the query above returns the document for `c.txt`. |

---

## Acceptance

1. With the three files shown above, exactly two directories appear under `./output/metadata/by-id/` and each path under `./output/metadata/by-path/` resolves to one of those directories.
2. Querying the search index for `copies = 1` returns the document for `c.txt`.
3. Querying by file `id`, by `paths = "c.txt"`, by that document's `mtime`, by MIME `type` and by `copies = 1` each return the same single document.
