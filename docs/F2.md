# F2. “I want to search for unique files by metadata”

## Value

The search index lets you surface a single file even when identical copies live in multiple places.

---

## Usage

When Home-Index syncs your files it:

* stores one **document** per unique file under `output/metadata/by-id/<file-hash>/document.json`;
* creates a **symlink** for every path in `output/metadata/by-path/...`;
* records all locations in the document’s `paths` map and `paths_list` array;
* counts duplicates in the `copies` field.

All of these fields (`id`, `paths_list`, `mtime`, `size`, `type`, `copies`, …) are filterable in the **files** index. Example:

```bash
curl -X POST 'http://localhost:7700/indexes/files/search' \
     -H 'Content-Type: application/json' \
     --data '{"q":"","filter":"copies = 1"}'
```

---

## Acceptance

| Scenario                           | Home-Index **input**                                                                                  | Home-Index **output**                                                                                                                                                                                      |
| ---------------------------------- | ----------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1 – First sync with duplicates** | Place `a.txt` and `b.txt` (identical) plus `c.txt` (unique) in `./input/` and start the stack.        | `output/metadata/by-id/` contains **two** directories: one shared by *a* & *b*, one for *c*.  <br>`output/metadata/by-path/` contains three symlinks; the two for *a* & *b* resolve to the same directory. |
| **2 – Document fields**            | Open any `document.json` produced in Scenario 1.                                                      | Every document includes `id`, `paths`, `paths_list`, `mtime`, `size`, `type`, and `copies` with the expected values (duplicates show `copies = 2`, the unique file shows `copies = 1`).                    |
| **3 – Search by single field**     | Query the **files** index with one filter, e.g. `paths_list = "c.txt"` or `copies = 2`.               | The response contains the matching document, and no unrelated documents.                                                                                                                                   |
| **4 – Search by multiple fields**  | Query with a compound filter, e.g. `size = 7 AND copies = 1` or `type = "text/plain" AND copies = 2`. | Only the document that satisfies **all** conditions is returned.                                                                                                                                           |

---

## Minimal `docker-compose.yml`

```yaml
services:
  home-index:
    image: ghcr.io/nashspence/home-index:latest
    environment:
      - METADATA_DIRECTORY=/home-index/metadata
    volumes:
      - ./input:/files:ro
      - ./output:/home-index
    depends_on:
      - meilisearch

  meilisearch:
    image: getmeili/meilisearch:latest
    environment:
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ./output/meili:/meili_data
      - "7700:7700"
```
